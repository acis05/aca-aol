<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACA AOL — Accurate Online Importer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f97316',
            primaryDark: '#ea580c'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">

<!-- =========================
     1) LANDING PAGE
========================= -->
<section id="landingPage" class="min-h-screen">
  <header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="inline-flex items-center justify-center w-10 h-10 rounded-2xl bg-primary/10 text-primary font-extrabold">
          A
        </div>
        <div>
          <div class="text-sm font-bold leading-tight">ACA AOL</div>
          <div class="text-xs text-slate-500 leading-tight">Accurate Online Importer</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnGoLoginTop"
          class="rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark transition">
          Masuk
        </button>
      </div>
    </div>
  </header>

  <main>
    <section class="max-w-7xl mx-auto px-6 pt-10 pb-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center">
        <div class="lg:col-span-7">
          <div class="inline-flex items-center gap-2 rounded-full bg-primary/10 text-primary px-3 py-1 text-xs font-semibold">
            SaaS Import Transaksi Accurate Online
          </div>
          <h1 class="text-4xl lg:text-5xl font-extrabold tracking-tight mt-4">
            Import transaksi Accurate Online dari Excel, rapi & cepat.
          </h1>
          <p class="text-slate-600 mt-4 text-lg leading-relaxed">
            ACA AOL membantu tim finance mengimpor transaksi (mulai dari <b>Jurnal Voucher</b>, <b>Sales Invoice</b>, dan <b>Sales Receipt</b>)
            tanpa ribet mapping manual. Cocok untuk volume tinggi, multi database, dan kebutuhan standardisasi template.
          </p>

          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <button id="btnGoLoginHero"
              class="rounded-xl bg-primary text-white px-5 py-3 text-sm font-semibold hover:bg-primaryDark transition">
              Masuk dengan Kode Akses
            </button>
            <a href="#features"
              class="rounded-xl bg-white border border-slate-200 px-5 py-3 text-sm font-semibold hover:bg-slate-50 transition text-center">
              Lihat Fitur
            </a>
          </div>

          <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
              <div class="text-xs text-slate-500">Workflow</div>
              <div class="font-semibold mt-1">Preview → Validasi → Import</div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
              <div class="text-xs text-slate-500">Multi DB</div>
              <div class="font-semibold mt-1">Pilih Data Usaha</div>
            </div>
            <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
              <div class="text-xs text-slate-500">Audit-friendly</div>
              <div class="font-semibold mt-1">Log hasil import</div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-5">
          <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-500">Status Akses</div>
                <div id="landingAccessStatus" class="font-semibold">Checking...</div>
              </div>
              <span id="landingTenantPill"
                class="text-xs px-3 py-1 rounded-full bg-primary/10 text-primary font-semibold">
                Tenant: -
              </span>
            </div>

            <div class="mt-5 space-y-3">
              <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
                <div class="text-sm font-semibold">Cara mulai</div>
                <ol class="mt-2 text-sm text-slate-600 list-decimal ml-5 space-y-1">
                  <li>Masuk pakai <b>kode akses</b> yang kami berikan</li>
                  <li>Login OAuth Accurate untuk izin API</li>
                  <li>Pilih Data Usaha</li>
                  <li>Upload Excel → Preview → Validasi → Import</li>
                </ol>
              </div>

              <button id="btnGoLoginCard"
                class="w-full rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark transition">
                Masuk
              </button>

              <p class="text-xs text-slate-500">
                Catatan: tiap customer akan dapat <b>subdomain</b> sendiri (mis. <span class="font-mono">acis.aca-aol.id</span>).
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="features" class="max-w-7xl mx-auto px-6 pb-14">
      <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-8">
        <h2 class="text-2xl font-extrabold">Fitur utama</h2>
        <p class="text-slate-600 mt-1">Dibuat untuk operasional finance harian yang butuh rapi, cepat, dan minim error.</p>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-primary font-bold">Validasi otomatis</div>
            <div class="text-sm text-slate-600 mt-1">Cek kolom wajib, format tanggal, balance, dll.</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-primary font-bold">Log mudah dibaca</div>
            <div class="text-sm text-slate-600 mt-1">Tahu transaksi mana sukses/gagal, plus pesan error yang jelas.</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-5">
            <div class="text-primary font-bold">Multi database</div>
            <div class="text-sm text-slate-600 mt-1">Dalam 1 akun Accurate, bisa pilih Data Usaha yang aktif.</div>
          </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="btnGoLoginBottom"
            class="rounded-xl bg-primary text-white px-5 py-3 text-sm font-semibold hover:bg-primaryDark transition">
            Masuk sekarang
          </button>
          <button id="btnOpenLoginInfo"
            class="rounded-xl bg-white border border-slate-200 px-5 py-3 text-sm font-semibold hover:bg-slate-50 transition">
            Cara login
          </button>
        </div>
      </div>
    </section>

    <footer class="pb-10">
      <div class="max-w-7xl mx-auto px-6 text-xs text-slate-500">
        © <span id="yearNow"></span> ACA AOL — Accurate Online Importer
      </div>
    </footer>
  </main>
</section>

<!-- =========================
     2) GATE LOGIN
========================= -->
<section id="gatePage" class="hidden min-h-screen">
  <div class="min-h-screen flex items-center justify-center px-6">
    <div class="w-full max-w-md">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-primary/10 text-primary font-bold">
          AO
        </div>
        <h1 class="text-2xl font-extrabold mt-3">Masuk ke Dashboard</h1>
        <p class="text-sm text-slate-600 mt-1">
          Masukkan <b>kode akses</b> untuk tenant ini.
        </p>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">Tenant / Subdomain</div>
            <div id="gateTenant" class="font-semibold">-</div>
          </div>
          <span id="gateStatusPill"
            class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">
            Ready
          </span>
        </div>

        <form id="gateForm" class="mt-5 space-y-3">
          <div>
            <label class="block text-sm font-medium">Kode Akses</label>
            <input id="accessCode" type="password" autocomplete="off" inputmode="text"
              placeholder="Masukkan kode akses"
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:outline-none" />
            <p class="text-xs text-slate-500 mt-2">
              Kode ini diberikan oleh admin saat langganan aktif.
            </p>
          </div>

          <button id="btnGateLogin" type="submit"
            class="w-full rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark transition disabled:opacity-60">
            Masuk
          </button>

          <div id="gateError" class="hidden text-sm text-rose-700"></div>

          <div class="pt-3 border-t border-slate-200 flex items-center justify-between text-xs text-slate-500">
            <button id="btnBackToLanding" type="button" class="hover:text-slate-700 font-semibold">
              ← Kembali
            </button>
            <span>Butuh bantuan? hubungi admin</span>
          </div>
        </form>
      </div>

      <div class="text-center text-xs text-slate-500 mt-4">
        © <span id="yearNow2"></span> ACA AOL
      </div>
    </div>
  </div>
</section>

<!-- =========================
     3) DASHBOARD
========================= -->
<div id="appShell" class="hidden">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-slate-900">Accurate Online Importer</h1>
        <p class="text-sm text-slate-500">Dashboard • pilih modul • upload & import transaksi</p>
      </div>

      <div class="flex items-center gap-3">
        <span id="tenantBadge"
          class="text-xs px-3 py-1 rounded-full bg-primary/10 text-primary font-semibold">
          Tenant: -
        </span>

        <span id="oauthBadge"
          class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">
          OAuth: checking...
        </span>

        <a href="/oauth/login"
           class="inline-flex items-center justify-center rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark transition">
          Login Accurate
        </a>

        <button id="btnLogout"
          class="inline-flex items-center justify-center rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50 transition">
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="p-5 border-b border-slate-200">
            <div class="text-xs text-slate-500">Modules</div>
            <div class="text-lg font-semibold">Pilih Modul</div>
            <p class="text-sm text-slate-600 mt-1">Pilih jenis transaksi yang mau diimpor.</p>
          </div>

          <nav class="p-2 space-y-1">
            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="journal_voucher">
              <span>
                <div class="font-semibold">Jurnal Voucher</div>
                <div class="text-xs text-slate-500">Import jurnal umum</div>
              </span>
              <span class="module-pill text-xs px-2 py-1 rounded-full bg-primary/10 text-primary font-semibold">Ready</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="sales_invoice">
              <span><div class="font-semibold">Sales Invoice</div><div class="text-xs text-slate-500">Faktur penjualan</div></span>
              <span class="module-pill text-xs px-2 py-1 rounded-full bg-primary/10 text-primary font-semibold">Ready</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="sales_receipt">
              <span><div class="font-semibold">Sales Receipt</div><div class="text-xs text-slate-500">Penerimaan penjualan</div></span>
              <span class="module-pill text-xs px-2 py-1 rounded-full bg-primary/10 text-primary font-semibold">Ready</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="payment">
              <span><div class="font-semibold">Payment</div><div class="text-xs text-slate-500">Pembayaran</div></span>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Soon</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="deposit">
              <span><div class="font-semibold">Deposit</div><div class="text-xs text-slate-500">Setoran</div></span>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Soon</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="sales_order">
              <span><div class="font-semibold">Sales Order</div><div class="text-xs text-slate-500">Pesanan penjualan</div></span>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Soon</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="purchase_invoice">
              <span><div class="font-semibold">Purchase Invoice</div><div class="text-xs text-slate-500">Faktur pembelian</div></span>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Soon</span>
            </button>

            <button class="module-btn w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 flex items-center justify-between"
                    data-module="purchase_payment">
              <span><div class="font-semibold">Purchase Payment</div><div class="text-xs text-slate-500">Pembayaran pembelian</div></span>
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">Soon</span>
            </button>
          </nav>

          <div class="p-5 border-t border-slate-200">
            <div class="text-xs text-slate-500">Tips</div>
            <div class="text-sm text-slate-600 mt-1">
              Modul aktif saat ini: <span id="activeModuleName" class="font-semibold text-slate-900">Jurnal Voucher</span>
            </div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-9 space-y-6">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">Module</div>
            <h2 id="moduleTitle" class="text-xl font-bold">Jurnal Voucher</h2>
            <p id="moduleDesc" class="text-sm text-slate-600 mt-1">
              Upload Excel → Preview → Validasi → Import ke Accurate.
            </p>
          </div>

          <div class="text-right">
            <div class="text-xs text-slate-500">Status</div>
            <div id="moduleStatusPill"
                 class="inline-flex items-center rounded-full bg-primary/10 text-primary px-3 py-1 text-xs font-semibold">
              Ready
            </div>
          </div>
        </div>

        <!-- MODULE (shared UI for JV, SI, SR) -->
        <div id="moduleMain" class="space-y-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- LEFT -->
            <div class="space-y-6">

              <!-- Company Picker -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <h3 class="font-semibold text-lg mb-1">0) Pilih Data Usaha</h3>
                <p class="text-sm text-slate-600">Pilih dulu database sebelum import.</p>

                <div class="mt-4">
                  <label class="block text-sm font-medium">Data Usaha</label>
                  <select id="companySelect"
                    class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:outline-none">
                  </select>
                  <p class="text-xs text-slate-500 mt-2">
                    Kalau daftar kosong, pastikan sudah OAuth, atau tambah manual via link <span class="font-mono">open.do?id=...</span>.
                  </p>
                </div>

                <div class="mt-4 flex gap-2">
                  <button id="btnSetCompany"
                    class="flex-1 rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark">
                    Pakai Data Usaha
                  </button>
                  <button id="btnRefreshCompanies"
                    class="rounded-xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50">
                    Refresh
                  </button>
                </div>

                <div class="mt-4">
                  <label class="block text-sm font-medium">Tambah dari link (opsional)</label>
                  <input id="companyUrl" type="text"
                    placeholder="https://zeus.accurate.id/accurate/open.do?id=xxxx"
                    class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:outline-none" />
                  <button id="btnAddCompanyFromUrl"
                    class="mt-2 w-full rounded-xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50">
                    Tambah ke daftar
                  </button>
                </div>

                <div id="companyStatus" class="text-xs text-slate-600 mt-3"></div>
              </section>

              <!-- Upload -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <h3 class="font-semibold text-lg">1) Upload Excel</h3>

                <div class="mt-4">
                  <input id="file" type="file" accept=".xlsx,.xls" class="block w-full text-sm" />
                  <p id="requiredColsHint" class="text-xs text-slate-500 mt-2">
                    Kolom wajib: ...
                  </p>
                </div>

                <div id="sessionIdWrap" class="mt-4">
                  <label class="block text-sm font-medium">X-Session-ID (opsional)</label>
                  <input id="sessionId" type="text" placeholder="Kosongkan jika pakai OAuth + pilih Data Usaha"
                    class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:outline-none" />
                  <p class="text-xs text-slate-500 mt-2">Kosongkan jika pakai OAuth + pilih Data Usaha.</p>
                </div>

                <div class="mt-6 flex gap-2">
                  <button id="btnPreview"
                    class="flex-1 rounded-xl bg-slate-800 text-white px-4 py-2 text-sm hover:bg-slate-900 disabled:opacity-60">
                    Preview
                  </button>
                  <button id="btnValidate"
                    class="flex-1 rounded-xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50 disabled:opacity-60">
                    Validasi
                  </button>
                </div>

                <button id="btnImport"
                  class="mt-3 w-full rounded-xl bg-primary text-white px-4 py-2 text-sm font-semibold hover:bg-primaryDark disabled:opacity-60">
                  Import ke Accurate
                </button>

                <div class="mt-4">
                  <div id="status" class="text-sm"></div>
                  <div id="progressWrap" class="hidden mt-3">
                    <div class="w-full bg-slate-100 rounded-full h-2">
                      <div id="progressBar" class="bg-primary h-2 rounded-full" style="width:0%"></div>
                    </div>
                    <div id="progressText" class="text-xs text-slate-500 mt-2"></div>
                  </div>
                </div>
              </section>

              <!-- Template -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <h3 class="font-semibold text-lg">Template Excel</h3>
                <p id="templateDesc" class="text-sm text-slate-700 mt-2">-</p>

                <div class="mt-3 flex gap-2">
                  <a id="templateDownload"
                     href="#"
                     class="flex-1 text-center rounded-xl bg-white border border-slate-300 px-4 py-2 text-sm font-semibold hover:bg-slate-50">
                    Download Template
                  </a>
                </div>

                <ul id="templateBullets" class="text-sm text-slate-700 mt-3 list-disc ml-5 space-y-1"></ul>
                <p id="templateOptional" class="text-xs text-slate-500 mt-3">-</p>
              </section>

            </div>

            <!-- RIGHT -->
            <div class="lg:col-span-2 space-y-6">

              <!-- Preview -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold text-lg">2) Preview Data</h3>
                  <span id="previewMeta" class="text-xs text-slate-500"></span>
                </div>

                <div class="mt-4 overflow-auto border border-slate-200 rounded-xl">
                  <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 text-slate-600">
                      <tr id="previewHead"></tr>
                    </thead>
                    <tbody id="previewBody" class="divide-y divide-slate-200"></tbody>
                  </table>
                </div>
              </section>

              <!-- Validation -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold text-lg">3) Hasil Validasi</h3>
                  <span id="validateMeta" class="text-xs text-slate-500"></span>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div class="rounded-xl border border-slate-200 p-3">
                    <div class="text-xs text-slate-500">Total Baris</div>
                    <div id="sumRows" class="text-lg font-semibold">-</div>
                  </div>
                  <div class="rounded-xl border border-slate-200 p-3">
                    <div id="sumDetectedLabel" class="text-xs text-slate-500">Terdeteksi</div>
                    <div id="sumDetected" class="text-lg font-semibold">-</div>
                  </div>
                  <div class="rounded-xl border border-slate-200 p-3">
                    <div id="sumValidLabel" class="text-xs text-slate-500">Valid</div>
                    <div id="sumValid" class="text-lg font-semibold">-</div>
                  </div>
                  <div class="rounded-xl border border-slate-200 p-3">
                    <div class="text-xs text-slate-500">Error</div>
                    <div id="sumErrors" class="text-lg font-semibold">-</div>
                  </div>
                </div>

                <div class="mt-4">
                  <h4 class="font-medium">Error (jika ada)</h4>
                  <div class="mt-2 overflow-auto border border-slate-200 rounded-xl">
                    <table class="min-w-full text-sm">
                      <thead class="bg-slate-50 text-slate-600">
                        <tr>
                          <th class="text-left p-2">Tipe</th>
                          <th id="errorKeyHead" class="text-left p-2">Key</th>
                          <th class="text-left p-2">Row</th>
                          <th class="text-left p-2">Pesan</th>
                        </tr>
                      </thead>
                      <tbody id="errorBody" class="divide-y divide-slate-200"></tbody>
                    </table>
                  </div>
                  <p class="text-xs text-slate-500 mt-2">Kalau masih ada error, import akan ditolak agar aman.</p>
                </div>

                <div class="mt-6">
                  <h4 id="sampleTitle" class="font-medium">Contoh data yang akan dikirim (maks 20)</h4>
                  <div class="mt-2 overflow-auto border border-slate-200 rounded-xl">
                    <table class="min-w-full text-sm">
                      <thead class="bg-slate-50 text-slate-600">
                        <tr id="sampleHead"></tr>
                      </thead>
                      <tbody id="sampleBody" class="divide-y divide-slate-200"></tbody>
                    </table>
                  </div>
                </div>
              </section>

              <!-- Log -->
              <section class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold text-lg">4) Log Import</h3>
                  <span id="jobMeta" class="text-xs text-slate-500"></span>
                </div>

                <div class="mt-4 flex flex-wrap gap-2 items-center justify-between">
                  <div class="flex gap-2">
                    <button id="btnViewSimple"
                      class="rounded-xl bg-slate-900 text-white px-3 py-2 text-xs font-semibold hover:bg-slate-800">
                      Tampilan Ringkas
                    </button>
                    <button id="btnViewRaw"
                      class="rounded-xl bg-white border border-slate-200 px-3 py-2 text-xs font-semibold hover:bg-slate-50">
                      Tampilan JSON (raw)
                    </button>
                  </div>

                  <div class="flex gap-2 items-center">
                    <input id="logFilter" type="text" placeholder="Filter key / pesan..."
                      class="w-56 rounded-xl border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-primary" />
                    <button id="btnCopyLog"
                      class="rounded-xl bg-white border border-slate-200 px-3 py-2 text-xs font-semibold hover:bg-slate-50">
                      Copy
                    </button>
                  </div>
                </div>

                <div id="simpleLogWrap" class="mt-4 overflow-auto border border-slate-200 rounded-xl">
                  <table class="min-w-full text-sm">
                    <thead class="bg-slate-50 text-slate-600">
                      <tr>
                        <th class="text-left p-2">Status</th>
                        <th id="logKeyHead" class="text-left p-2">Key</th>
                        <th class="text-left p-2">Nomor</th>
                        <th class="text-left p-2">Pesan</th>
                      </tr>
                    </thead>
                    <tbody id="simpleLogBody" class="divide-y divide-slate-200"></tbody>
                  </table>
                </div>

                <div id="rawLogWrap" class="hidden mt-4 overflow-auto border border-slate-200 rounded-xl">
                  <pre id="jobLog" class="text-xs p-3 whitespace-pre-wrap"></pre>
                </div>

                <p class="text-xs text-slate-500 mt-2">
                  Tips: kalau gagal, cek master (customerNo/itemNo/bankNo/invoiceNo), format tanggal, dan field wajib.
                </p>
              </section>

            </div>
          </div>
        </div>

        <!-- Placeholder -->
        <div id="modulePlaceholder" class="hidden">
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <div class="inline-flex items-center rounded-full bg-slate-100 text-slate-700 px-3 py-1 text-xs font-semibold">
              Coming soon
            </div>
            <h3 class="text-xl font-bold mt-3">Modul belum aktif</h3>
            <p class="text-sm text-slate-600 mt-1">
              Endpoint & formnya akan kita sambungkan setelah ini.
            </p>
          </div>
        </div>

      </section>
    </div>
  </main>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function show(el, yes=true) {
    if (!el) return;
    el.classList.toggle("hidden", !yes);
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setGateError(msg) {
    const el = $("gateError");
    if (!el) return;
    if (!msg) { show(el, false); el.textContent = ""; return; }
    el.textContent = msg;
    show(el, true);
  }

  function setStatus(msg, kind="info") {
    const el = $("status");
    if (!el) return;
    el.className = "text-sm " + (kind === "error" ? "text-rose-700" : kind === "ok" ? "text-emerald-700" : "text-slate-700");
    el.textContent = msg;
  }

  function setProgress(showIt, percent=0, text="") {
    const wrap = $("progressWrap");
    if (!wrap) return;
    if (!showIt) { wrap.classList.add("hidden"); return; }
    wrap.classList.remove("hidden");
    $("progressBar").style.width = `${percent}%`;
    $("progressText").textContent = text;
  }

  function getFile() {
    const f = $("file")?.files?.[0];
    if (!f) throw new Error("Pilih file Excel dulu.");
    return f;
  }

  async function postFile(url, file, extraForm={}) {
    const fd = new FormData();
    fd.append("file", file);
    for (const [k,v] of Object.entries(extraForm)) fd.append(k, v);
    const res = await fetch(url, { method: "POST", body: fd });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json.error || "Request gagal");
    return json;
  }

  function getTenantFromHost() {
    const h = (location.hostname || "").toLowerCase();
    const parts = h.split(".");
    if (parts.length >= 3) return parts[0];
    return h || "localhost";
  }

  async function checkAccess() {
    const year = new Date().getFullYear();
    if ($("yearNow")) $("yearNow").textContent = year;
    if ($("yearNow2")) $("yearNow2").textContent = year;

    const tenant = getTenantFromHost();
    if ($("landingTenantPill")) $("landingTenantPill").textContent = `Tenant: ${tenant || "-"}`;
    if ($("gateTenant")) $("gateTenant").textContent = tenant || "-";
    if ($("tenantBadge")) $("tenantBadge").textContent = `Tenant: ${tenant || "-"}`;

    try {
      const r = await fetch("/auth/status");
      const s = await r.json();

      if (!s.configured) {
        if ($("landingAccessStatus")) $("landingAccessStatus").textContent = "Tenant belum terdaftar";
        show($("landingPage"), true);
        show($("gatePage"), false);
        show($("appShell"), false);
        return;
      }

      if (s.access_ok) {
        show($("landingPage"), false);
        show($("gatePage"), false);
        show($("appShell"), true);
        initDashboard();
        refreshOauthBadge();
        loadCompanies();
        return;
      }

      if ($("landingAccessStatus")) $("landingAccessStatus").textContent = "Silakan masuk dengan kode akses";
      show($("landingPage"), true);
      show($("gatePage"), false);
      show($("appShell"), false);
    } catch {
      if ($("landingAccessStatus")) $("landingAccessStatus").textContent = "Gagal cek status akses (backend error)";
      show($("landingPage"), true);
      show($("gatePage"), false);
      show($("appShell"), false);
    }
  }

  function goLogin() {
    setGateError("");
    show($("landingPage"), false);
    show($("gatePage"), true);
    show($("appShell"), false);
    $("accessCode")?.focus();
  }

  function backToLanding() {
    setGateError("");
    show($("landingPage"), true);
    show($("gatePage"), false);
    show($("appShell"), false);
  }

  $("btnGoLoginTop")?.addEventListener("click", goLogin);
  $("btnGoLoginHero")?.addEventListener("click", goLogin);
  $("btnGoLoginCard")?.addEventListener("click", goLogin);
  $("btnGoLoginBottom")?.addEventListener("click", goLogin);
  $("btnOpenLoginInfo")?.addEventListener("click", goLogin);
  $("btnBackToLanding")?.addEventListener("click", backToLanding);

  $("gateForm")?.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    setGateError("");
    const btn = $("btnGateLogin");
    if (btn) { btn.disabled = true; btn.textContent = "Memproses..."; }

    try {
      const code = ($("accessCode")?.value || "").trim();
      if (!code) throw new Error("Kode akses kosong.");
      const res = await fetch("/auth/verify", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ code })
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || "Kode akses salah.");
      location.reload();
    } catch (e) {
      setGateError(e.message || "Kode akses salah.");
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = "Masuk"; }
    }
  });

  $("btnLogout")?.addEventListener("click", async () => {
    try {
      await fetch("/auth/logout", { method: "POST", headers: {"Content-Type":"application/json"}, body: "{}" });
      location.reload();
    } catch {
      alert("Gagal logout");
    }
  });

  // ===== Module switcher =====
  const MODULES = {
    journal_voucher: { name: "Jurnal Voucher", desc: "Upload Excel → Preview → Validasi → Import ke Accurate.", ready: true },
    sales_invoice: { name: "Sales Invoice", desc: "Upload Excel → Preview → Validasi → Import Sales Invoice ke Accurate.", ready: true },
    sales_receipt: { name: "Sales Receipt", desc: "Upload Excel → Preview → Validasi → Import Sales Receipt ke Accurate.", ready: true },
    payment: { name: "Payment", desc: "Import pembayaran.", ready: false },
    deposit: { name: "Deposit", desc: "Import setoran.", ready: false },
    sales_order: { name: "Sales Order", desc: "Import pesanan penjualan.", ready: false },
    purchase_invoice: { name: "Purchase Invoice", desc: "Import faktur pembelian.", ready: false },
    purchase_payment: { name: "Purchase Payment", desc: "Import pembayaran pembelian.", ready: false },
  };

  let activeModule = "journal_voucher";

  const API = {
    journal_voucher: {
      preview: "/api/preview",
      validate: "/api/validate",
      import: "/api/import",
      keyLabel: "jurnal_key",
      errorKeyField: "jurnal_key",
      sampleKey: "journals_sample",
      summaryDetected: "total_journals_detected",
      summaryValid: "valid_journals",
      showSessionId: true,
      requiredHint: "Kolom wajib: jurnal_key, transDate, accountNo, amountType, amount",
      templateUrl: "/templates/journal-voucher.xlsx",
      templateDesc: "Template untuk import Journal Voucher.",
      templateBullets: [
        "<b>jurnal_key</b> = pengelompokan 1 jurnal",
        "<b>transDate</b> = dd/mm/yyyy",
        "<b>amountType</b> = DEBIT / CREDIT",
        "<b>amount</b> = angka &gt; 0",
      ],
      templateOptional: "Optional: description, number, memo, subsidiaryType, customerNo/vendorNo/employeeNo, rate, primeAmount",
      detectedLabel: "Jurnal Terdeteksi",
      validLabel: "Jurnal Valid",
      sampleTitle: "Contoh jurnal yang akan dikirim (maks 20)",
      sampleHeaders: [
        ["jurnal_key", "jurnal_key"],
        ["transDate", "Tanggal"],
        ["number", "Nomor"],
        ["description", "Deskripsi"],
        ["lines", "Lines"],
        ["debit", "Debit"],
        ["credit", "Credit"],
      ],
    },

    sales_invoice: {
      preview: "/api/sales-invoice/preview",
      validate: "/api/sales-invoice/validate",
      import: "/api/sales-invoice/import",
      keyLabel: "invoice_key",
      errorKeyField: "invoice_key",
      sampleKey: "invoices_sample",
      summaryDetected: "total_invoices_detected",
      summaryValid: "valid_invoices",
      showSessionId: false,
      requiredHint: "Kolom wajib: invoice_key, transDate, customerNo, itemNo, unitPrice (quantity optional)",
      templateUrl: "/templates/sales-invoice.xlsx",
      templateDesc: "Template untuk import Sales Invoice.",
      templateBullets: [
        "<b>invoice_key</b> = pengelompokan 1 invoice",
        "<b>transDate</b> = dd/mm/yyyy (WAJIB)",
        "<b>customerNo</b> = kode customer",
        "<b>itemNo</b> + <b>unitPrice</b> wajib per baris item",
      ],
      templateOptional: "Optional: quantity (default 1), number, description, currencyCode, inclusiveTax, taxable, warehouseName, dll.",
      detectedLabel: "Invoice Terdeteksi",
      validLabel: "Invoice Valid",
      sampleTitle: "Contoh invoice yang akan dikirim (maks 20)",
      sampleHeaders: [
        ["invoice_key", "invoice_key"],
        ["transDate", "Tanggal"],
        ["number", "Nomor"],
        ["customerNo", "Customer"],
        ["lines", "Lines"],
        ["currencyCode", "Currency"],
        ["_", "-"],
      ],
    },

    sales_receipt: {
      preview: "/api/sales-receipt/preview",
      validate: "/api/sales-receipt/validate",
      import: "/api/sales-receipt/import",
      keyLabel: "receipt_key",
      errorKeyField: "receipt_key",
      sampleKey: "receipts_sample",
      summaryDetected: "total_receipts_detected",
      summaryValid: "valid_receipts",
      showSessionId: false,
      requiredHint: "Kolom wajib: receipt_key, transDate, bankNo, customerNo, invoiceNo, paymentAmount (chequeAmount bisa kosong, akan dihitung)",
      templateUrl: "/templates/sales-receipt.xlsx",
      templateDesc: "Template untuk import Sales Receipt (Penerimaan Penjualan).",
      templateBullets: [
        "<b>receipt_key</b> = pengelompokan 1 transaksi penerimaan",
        "<b>transDate</b> = dd/mm/yyyy (WAJIB)",
        "<b>bankNo</b> = akun bank penerimaan",
        "<b>customerNo</b> = kode customer",
        "<b>invoiceNo</b> + <b>paymentAmount</b> wajib per baris invoice",
      ],
      templateOptional: "Optional: chequeAmount (jika kosong dihitung), number, description, paymentMethod (BANK_TRANSFER/QRIS/dll), discountAccountNo+discountAmount, dll.",
      detectedLabel: "Receipt Terdeteksi",
      validLabel: "Receipt Valid",
      sampleTitle: "Contoh receipt yang akan dikirim (maks 20)",
      sampleHeaders: [
        ["receipt_key", "receipt_key"],
        ["transDate", "Tanggal"],
        ["number", "Nomor"],
        ["customerNo", "Customer"],
        ["bankNo", "Bank"],
        ["invoices", "Invoices"],
        ["chequeAmount", "ChequeAmount"],
      ],
    }
  };

  function renderSampleHeader() {
    const head = $("sampleHead");
    if (!head) return;
    head.innerHTML = "";
    const cfg = API[activeModule] || API.journal_voucher;
    const cols = cfg.sampleHeaders || [];
    for (const [, label] of cols) {
      const th = document.createElement("th");
      th.className = "text-left p-2";
      th.textContent = label;
      head.appendChild(th);
    }
  }

  function applyModuleUI() {
    const m = MODULES[activeModule] || MODULES.journal_voucher;
    const cfg = API[activeModule] || API.journal_voucher;

    $("activeModuleName").textContent = m.name;
    $("moduleTitle").textContent = m.name;
    $("moduleDesc").textContent = m.desc;

    const pill = $("moduleStatusPill");
    if (pill) {
      if (m.ready) {
        pill.className = "inline-flex items-center rounded-full bg-primary/10 text-primary px-3 py-1 text-xs font-semibold";
        pill.textContent = "Ready";
      } else {
        pill.className = "inline-flex items-center rounded-full bg-slate-100 text-slate-700 px-3 py-1 text-xs font-semibold";
        pill.textContent = "Coming soon";
      }
    }

    // shared UI shown only for ready modules we implement
    const implemented = ["journal_voucher", "sales_invoice", "sales_receipt"].includes(activeModule);
    show($("moduleMain"), implemented);
    show($("modulePlaceholder"), !implemented);

    // session id toggle
    show($("sessionIdWrap"), !!cfg.showSessionId);

    // hint & labels
    if ($("requiredColsHint")) $("requiredColsHint").innerHTML = cfg.requiredHint;
    if ($("sumDetectedLabel")) $("sumDetectedLabel").textContent = cfg.detectedLabel;
    if ($("sumValidLabel")) $("sumValidLabel").textContent = cfg.validLabel;
    if ($("sampleTitle")) $("sampleTitle").textContent = cfg.sampleTitle;
    if ($("errorKeyHead")) $("errorKeyHead").textContent = cfg.keyLabel;
    if ($("logKeyHead")) $("logKeyHead").textContent = cfg.keyLabel;
    if ($("logFilter")) $("logFilter").setAttribute("placeholder", `Filter ${cfg.keyLabel} / pesan...`);

    // template
    if ($("templateDesc")) $("templateDesc").textContent = cfg.templateDesc;
    if ($("templateDownload")) $("templateDownload").setAttribute("href", cfg.templateUrl);
    if ($("templateBullets")) {
      $("templateBullets").innerHTML = (cfg.templateBullets || []).map(x => `<li>${x}</li>`).join("");
    }
    if ($("templateOptional")) $("templateOptional").textContent = cfg.templateOptional;

    renderSampleHeader();

    // highlight active button
    document.querySelectorAll(".module-btn").forEach(btn => {
      const isActive = btn.dataset.module === activeModule;
      btn.classList.toggle("bg-primary/10", isActive);
      btn.classList.toggle("border", isActive);
      btn.classList.toggle("border-primary/20", isActive);
    });

    // clear outputs when switch module
    $("previewHead").innerHTML = "";
    $("previewBody").innerHTML = "";
    $("previewMeta").textContent = "";
    $("errorBody").innerHTML = "";
    $("sampleBody").innerHTML = "";
    $("validateMeta").textContent = "";
    $("sumRows").textContent = "-";
    $("sumDetected").textContent = "-";
    $("sumValid").textContent = "-";
    $("sumErrors").textContent = "-";
    $("jobMeta").textContent = "";
    lastJob = null;
    $("simpleLogBody").innerHTML = "";
    $("jobLog").textContent = "";
    setStatus("", "info");
    setProgress(false);
  }

  function activateModule(key) {
    activeModule = key;
    applyModuleUI();
  }

  function initDashboard() {
    document.querySelectorAll(".module-btn").forEach(btn => {
      btn.addEventListener("click", () => activateModule(btn.dataset.module));
    });
    activateModule("journal_voucher");
  }

  // ===== OAuth badge =====
  async function refreshOauthBadge() {
    const b = $("oauthBadge");
    if (!b) return;
    try {
      const r = await fetch("/oauth/status");
      const s = await r.json();
      if (s.logged_in) {
        b.textContent = "OAuth: logged-in";
        b.className = "text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700";
      } else {
        b.textContent = "OAuth: not logged-in";
        b.className = "text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600";
      }
    } catch {
      b.textContent = "OAuth: unknown";
      b.className = "text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600";
    }
  }

  // ===== Company picker =====
  async function loadCompanies() {
    const st = $("companyStatus");
    const sel = $("companySelect");
    if (!sel) return;
    if (st) st.textContent = "Memuat daftar data usaha...";

    try {
      const r = await fetch("/accurate/companies");
      const data = await r.json();

      sel.innerHTML = "";
      (data.items || []).forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (id: ${it.id})`;
        sel.appendChild(opt);
      });

      if (data.selected_company_id) {
        sel.value = data.selected_company_id;
        if (st) st.textContent = `Terpilih saat ini: ${data.selected_company_id}`;
      } else {
        if (st) st.textContent = (data.items && data.items.length)
          ? "Silakan pilih Data Usaha lalu klik 'Pakai Data Usaha'."
          : "Belum ada Data Usaha tersimpan.";
      }

      if (data.warning && st) st.textContent += ` (Warning: ${data.warning})`;
    } catch {
      if (st) st.textContent = "❌ Gagal memuat daftar data usaha.";
    }
  }

  async function setCompany() {
    const sel = $("companySelect");
    const st = $("companyStatus");
    if (!sel) return;
    const id = sel.value;
    const r = await fetch("/accurate/select-company", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({id})
    });
    const data = await r.json().catch(() => ({}));
    if (st) st.textContent = data.ok ? `✅ Dipilih: ${data.selected}` : `❌ Gagal: ${data.error || "unknown"}`;
  }

  async function addCompanyFromUrl() {
    const url = ($("companyUrl")?.value || "").trim();
    const st = $("companyStatus");
    const r = await fetch("/accurate/add-company-from-url", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({url})
    });
    const data = await r.json().catch(() => ({}));
    if (st) st.textContent = data.ok ? `✅ Ditambah: ${data.item.name} (id: ${data.item.id})` : `❌ ${data.error || "unknown"}`;
    await loadCompanies();
  }

  $("btnRefreshCompanies")?.addEventListener("click", loadCompanies);
  $("btnSetCompany")?.addEventListener("click", setCompany);
  $("btnAddCompanyFromUrl")?.addEventListener("click", addCompanyFromUrl);

  // ===== Shared renderers =====
  function renderPreview(columns, rows) {
    const head = $("previewHead");
    const body = $("previewBody");
    if (!head || !body) return;
    head.innerHTML = "";
    body.innerHTML = "";

    const cols = (columns || []).slice(0, 12); // dinamis + limit
    for (const c of cols) {
      const th = document.createElement("th");
      th.className = "text-left p-2 whitespace-nowrap";
      th.textContent = c;
      head.appendChild(th);
    }

    for (const r of (rows || [])) {
      const tr = document.createElement("tr");
      for (const c of cols) {
        const td = document.createElement("td");
        td.className = "p-2 whitespace-nowrap";
        td.textContent = (r?.[c] ?? "").toString();
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }

    if ($("previewMeta")) $("previewMeta").textContent = `Menampilkan ${(rows || []).length} baris (kolom dibatasi 12)`;
  }

  function renderValidation(result) {
    const cfg = API[activeModule] || API.journal_voucher;
    const s = result.summary || {};

    $("sumRows").textContent = s.total_rows ?? "-";
    $("sumDetected").textContent = s[cfg.summaryDetected] ?? "-";
    $("sumValid").textContent = s[cfg.summaryValid] ?? "-";
    $("sumErrors").textContent = s.errors ?? "-";

    $("validateMeta").textContent = (s.errors ? "Perbaiki error dulu sebelum import." : "Valid. Siap import.");

    // errors
    const ebody = $("errorBody");
    ebody.innerHTML = "";
    for (const e of (result.errors || [])) {
      const keyVal = e[cfg.errorKeyField] ?? e.key ?? "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2">${escapeHtml(e.type)}</td>
        <td class="p-2">${escapeHtml(keyVal)}</td>
        <td class="p-2">${escapeHtml(e.row ?? "")}</td>
        <td class="p-2">${escapeHtml(e.message)}</td>
      `;
      ebody.appendChild(tr);
    }

    // sample table
    const sbody = $("sampleBody");
    sbody.innerHTML = "";

    const sampleArr = result[cfg.sampleKey] || [];
    const cols = cfg.sampleHeaders || [];
    for (const row of sampleArr) {
      const tr = document.createElement("tr");
      tr.innerHTML = cols.map(([field]) => {
        if (field === "_") return `<td class="p-2 text-slate-400">-</td>`;
        return `<td class="p-2">${escapeHtml(row?.[field] ?? "")}</td>`;
      }).join("");
      sbody.appendChild(tr);
    }
  }

  // ===== Log view (shared) =====
  let lastJob = null;
  let logView = "simple"; // simple | raw

  function getMsgFromItem(it) {
    if (it?.msg) return it.msg;
    if (it?.message) return Array.isArray(it.message) ? it.message.join("; ") : (it.message ?? "");
    if (it?.error) return Array.isArray(it.error) ? it.error.join("; ") : (it.error ?? "");
    return "";
  }

  function flattenResults(job) {
    const out = [];
    const logs = job?.logs || [];
    for (const b of logs) {
      const results = b?.results || [];
      for (const it of results) {
        out.push({
          ok: !!it.ok,
          key: it.key ?? it.jurnal_key ?? it.invoice_key ?? it.receipt_key ?? "",
          number: it.number ?? "",
          msg: getMsgFromItem(it) || "",
        });
      }
    }
    return out;
  }

  function renderSimpleLog(job) {
    const tbody = $("simpleLogBody");
    tbody.innerHTML = "";

    const filter = ($("logFilter")?.value || "").toLowerCase().trim();
    const rows = flattenResults(job).filter(x => {
      if (!filter) return true;
      return (x.key.toLowerCase().includes(filter) ||
              (x.number || "").toLowerCase().includes(filter) ||
              (x.msg || "").toLowerCase().includes(filter));
    });

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-3 text-slate-500 text-sm" colspan="4">Belum ada data log.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const r of rows) {
      const badge = r.ok
        ? `<span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 px-2 py-1 text-xs font-semibold">OK</span>`
        : `<span class="inline-flex items-center rounded-full bg-rose-50 text-rose-700 px-2 py-1 text-xs font-semibold">FAIL</span>`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2">${badge}</td>
        <td class="p-2 font-medium">${escapeHtml(r.key)}</td>
        <td class="p-2">${escapeHtml(r.number)}</td>
        <td class="p-2">${escapeHtml(r.msg)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderRaw(job) {
    const el = $("jobLog");
    if (!el) return;
    el.textContent = JSON.stringify(job, null, 2);
  }

  function setLogView(view) {
    logView = view;
    if (view === "simple") {
      show($("simpleLogWrap"), true);
      show($("rawLogWrap"), false);
      if ($("btnViewSimple")) $("btnViewSimple").className = "rounded-xl bg-slate-900 text-white px-3 py-2 text-xs font-semibold hover:bg-slate-800";
      if ($("btnViewRaw")) $("btnViewRaw").className = "rounded-xl bg-white border border-slate-200 px-3 py-2 text-xs font-semibold hover:bg-slate-50";
      if (lastJob) renderSimpleLog(lastJob);
    } else {
      show($("simpleLogWrap"), false);
      show($("rawLogWrap"), true);
      if ($("btnViewSimple")) $("btnViewSimple").className = "rounded-xl bg-white border border-slate-200 px-3 py-2 text-xs font-semibold hover:bg-slate-50";
      if ($("btnViewRaw")) $("btnViewRaw").className = "rounded-xl bg-slate-900 text-white px-3 py-2 text-xs font-semibold hover:bg-slate-800";
      if (lastJob) renderRaw(lastJob);
    }
  }

  $("btnViewSimple")?.addEventListener("click", () => setLogView("simple"));
  $("btnViewRaw")?.addEventListener("click", () => setLogView("raw"));

  $("logFilter")?.addEventListener("input", () => {
    if (lastJob && logView === "simple") renderSimpleLog(lastJob);
  });

  $("btnCopyLog")?.addEventListener("click", async () => {
    const text = (logView === "raw")
      ? ($("jobLog")?.textContent || "")
      : ($("simpleLogWrap")?.innerText || "");
    try {
      await navigator.clipboard.writeText(text);
      setStatus("Log tersalin ke clipboard.", "ok");
    } catch {
      setStatus("Gagal copy (browser menolak).", "error");
    }
  });

  // ===== Actions: Preview / Validate / Import =====
  $("btnPreview")?.addEventListener("click", async () => {
    try {
      setStatus("Memproses preview...");
      setProgress(true, 20, "Upload & baca Excel...");
      const file = getFile();
      const cfg = API[activeModule] || API.journal_voucher;
      const r = await postFile(cfg.preview, file);
      renderPreview(r.columns, r.preview);
      setProgress(false);
      setStatus("Preview siap.", "ok");
    } catch (e) {
      setProgress(false);
      setStatus(e.message, "error");
    }
  });

  $("btnValidate")?.addEventListener("click", async () => {
    try {
      setStatus("Memproses validasi...");
      setProgress(true, 30, "Validasi data...");
      const file = getFile();
      const cfg = API[activeModule] || API.journal_voucher;
      const r = await postFile(cfg.validate, file);
      renderValidation(r);
      setProgress(false);
      const hasErr = !!(r.summary?.errors);
      setStatus(hasErr ? "Validasi selesai: masih ada error." : "Validasi OK. Siap import!", hasErr ? "error" : "ok");
    } catch (e) {
      setProgress(false);
      setStatus(e.message, "error");
    }
  });

  $("btnImport")?.addEventListener("click", async () => {
    try {
      setStatus("Mulai import...");
      setProgress(true, 10, "Menyiapkan data...");
      const file = getFile();
      const cfg = API[activeModule] || API.journal_voucher;

      const extra = {};
      if (cfg.showSessionId) {
        extra.session_id = ($("sessionId")?.value || "").trim();
      }

      const r = await postFile(cfg.import, file, extra);

      setProgress(true, 60, "Import dijalankan. Mengambil log job...");
      if ($("jobMeta")) $("jobMeta").textContent = `Job ID: ${r.job_id}`;
      await pollJob(r.job_id);
    } catch (e) {
      setProgress(false);
      setStatus(e.message, "error");
    }
  });

  async function pollJob(jobId) {
    setProgress(true, 70, "Mengambil status job...");
    for (let i = 0; i < 30; i++) {
      const res = await fetch(`/api/job/${jobId}`);
      const json = await res.json().catch(() => ({}));
      if (!res.ok || !json.ok) throw new Error(json.error || "Gagal membaca job");

      lastJob = json.job;

      if (logView === "raw") renderRaw(lastJob);
      else renderSimpleLog(lastJob);

      if (json.job.status === "done") {
        setProgress(false);
        setStatus("Import selesai. Cek log di bawah.", "ok");
        return;
      }
      await new Promise(r => setTimeout(r, 1000));
    }
    setProgress(false);
    setStatus("Job masih berjalan. Refresh halaman untuk cek log lagi.", "info");
  }

  // ===== Start =====
  setLogView("simple");
  checkAccess();
</script>

</body>
</html>
